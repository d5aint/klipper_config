[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause the print and park the toolhead
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set safe_extruder_temp = vars.safe_extruder_temp|float %}

    {% if printer.pause_resume.is_paused|int == 0 %}
        # Save the current print coordinates and temperature
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
        SAVE_GCODE_STATE NAME=PAUSE

        # 2. Halt Logic
        BASE_PAUSE

        # 3. Retraction (Revo HF Requirement), Prevent oozing by retracting filament immediately
        {% if printer.extruder.can_extrude %}
            G91
            G1 E-2.0 F3600  ; Retract 2mm at 60mm/s
            G90
        {% endif %}
        
        # 4. Park, We trust the PARK macro to handle Z-hop safety and XY movement
        PARK MODE=FRONT

        # 5. Standby, Drop temp to prevent cooking filament in the nozzle
        M104 S{safe_extruder_temp}
        # Extend timeout to 12 hours (43200s) for overnight pauses
        SET_IDLE_TIMEOUT TIMEOUT=43200

    {% else %}
        RESPOND MSG="Print is already paused"
    {% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
description: Resume the print after an optional unretract
variable_etemp: 0
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set St = vars.travel_speed * 60 %}

    {% if printer.pause_resume.is_paused|int == 1 %}
        # 1. Restore Hardware State
        {% if vars.filament_sensor_enabled %}
            SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        {% endif %}
        # Restore standard idle timeout
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

        # 2. Restore Temperature, We wait for the nozzle to reach the target temp before moving
        {% if etemp > 0 %}
            M109 S{etemp|int}
        {% endif %}

        # 3. Prime Nozzle (Revo HF Requirement)
        # We must re-pressurize the nozzle before printing resumes. We do this WHILE at the park position to catch the drool.
        G91
        G1 E2.0 F1500 ; Un-retract (Prime) 2mm
        G90

        # 4. Return to Print, Move back to the exact XYZ coordinate where we paused.
        # MOVE=1 tells Klipper to physically move there at MOVE_SPEED.
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED={St}

        # 5. Resume
        BASE_RESUME
    {% else %}
        RESPOND MSG="Print is not paused. Resume ignored"
    {% endif %}
