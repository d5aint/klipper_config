[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause and park toolhead at front center. Z hop by 10mm.
gcode:
    {% set Z = params.Z|default(10)|int %}
    {% set TEMP_OFFSET = params.TEMP_OFFSET|default(300)|int %}
    {% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
    {% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set z_safe = act_z + Z %}
    
    {% if z_safe > max_z %}
        {% set z_safe = max_z %}
    {% endif %}
    
    {% if printer.pause_resume.is_paused %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z_safe}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}
    
        SAVE_GCODE_STATE NAME=PAUSE
        BASE_PAUSE
    
        G91
        G1 Z{z_safe} F900
        G90
        SAVE_GCODE_STATE NAME=PAUSEHOPPED
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F12000
        SAVE_GCODE_STATE NAME=PAUSEPARK
    
        {% if printer['extruder'].target - TEMP_OFFSET < 0 or TEMP_OFFSET < 0 %}
            M104 S0
        {% else %}
            M104 S{printer['extruder'].target - TEMP_OFFSET}
        {% endif %}
    
        SET_IDLE_TIMEOUT TIMEOUT=7200
        LIGHT_ON S={light_intensity_start_print}
    
        {% if verbose %}
            RESPOND MSG="Paused"
        {% endif %}
    {% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
description: Return Z hop back down 10mm, prime nozzle (default 0), resume print
variable_zhop: 0
variable_etemp: 0
gcode:
    {% set E = params.E|default(0)|int %}
    {% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
    {% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
    {% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
    
    {% if not printer.pause_resume.is_paused %}
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    
        {% if etemp > 0 %}
            M109 S{etemp|int}
        {% endif %}
    
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED={St}
        RESTORE_GCODE_STATE NAME=PAUSEHOPPED MOVE=1 MOVE_SPEED={St}
        G91
        M83
    
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{E} F900
        {% else %}
            G1 Z{zhop * -1} F900
        {% endif %}
    
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED={St}
        
        {% if verbose %}
            RESPOND MSG="Printing"
        {% endif %}
        
        LIGHT_ON S={light_intensity_printing}
        BASE_RESUME
    {% endif %}
