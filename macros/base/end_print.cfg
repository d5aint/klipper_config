[gcode_macro END_PRINT]
description: Stop print, filter air, park safely, and prepare for inspection
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set safe_temp = vars.safe_extruder_temp|float %}
    {% set turn_off_heaters = vars.turn_off_heaters_in_end_print %}

    {% set MATERIAL = params.MATERIAL|default(vars.print_default_material)|string|upper %}
    {% set mat_settings = vars.material_parameters[MATERIAL] if MATERIAL in vars.material_parameters else vars.material_parameters['PLA'] %}

    {% set CHAMBER_FAN_ENABLE = mat_settings.chamber_filter_enable|default(0)|int %}
    {% set EXHAUST_FAN_ENABLE = mat_settings.exhaust_filter_enable|default(0)|int %}
    {% set CHAMBER_TIME = mat_settings.chamber_filter_time|default(600)|int %}
    {% set EXHAUST_TIME = mat_settings.exhaust_filter_time|default(600)|int %}

    # --- 1. SYSTEM SAFEGUARD ---
    CLEAR_PAUSE
    M400             ; Wait for buffer to clear
    G92 E0.0         ; Reset Extruder
    
    # Disable Filament Sensor (Prevent false runout during parking/cooling)
    {% if vars.filament_sensor_enabled %}
        SET_FILAMENT_SENSOR SENSOR="filament_sensor" ENABLE=0
    {% endif %}

    # --- 2. REVO HF RETRACTION ---
    # Immediate rapid retraction to snap the filament and prevent stringing on top surfaces
    {% if printer.extruder.can_extrude %}
        G91
        G1 E-2.0 F3000
        G1 E-2.0 Z0.2 F2400
        G1 E-18 F800
    {% endif %}

    # --- 3. PARKING ---
    # Park Rear Right (Safely offset by 30mm via PARK macro)
    PARK MODE=REAR

    # --- 4. SHUTDOWN ---
    {% if turn_off_heaters %}
        TURN_OFF_HEATERS
    {% else %}
        # Keep nozzle at safe temp if requested (rare)
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_temp}
    {% endif %}

    M107             ; Turn off Part Cooling Fan
    BED_MESH_CLEAR   ; Clear mesh state

    # --- 5. FILTER MANAGEMENT (VOC Scrubbing) ---
    # Chamber Filter (Nevermore)
    {% if CHAMBER_FAN_ENABLE %}
        { action_respond_info("Nevermore: Scrubbing VOCs for %d seconds..." % CHAMBER_TIME) }
        START_FILTER FILTER_NAME="{vars.filter_chamber_name}" SPEED=1
        UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED_CHAMBER DURATION={CHAMBER_TIME}
    {% else %}
        STOP_FILTER FILTER_NAME="{vars.filter_chamber_name}"
    {% endif %}

    # Exhaust Fan
    {% if EXHAUST_FAN_ENABLE %}
        { action_respond_info("Exhaust: Venting for %d seconds..." % EXHAUST_TIME) }
        START_FILTER FILTER_NAME="{vars.filter_exhaust_name}" SPEED=1
        UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED_EXHAUST DURATION={EXHAUST_TIME}
    {% else %}
        STOP_FILTER FILTER_NAME="{vars.filter_exhaust_name}"
    {% endif %}

    # --- 6. STATISTICS ---
    # (Assuming these helper macros exist in your config)
    {% if printer["gcode_macro _ADD_PRINT_TIME"] is defined %}
        _ADD_PRINT_TIME
    {% endif %}
    {% if printer["gcode_macro _SD_PRINT_STATS"] is defined %}
        _SD_PRINT_STATS R='done'
    {% endif %}
    {% if printer["gcode_macro _SD_PRINTER_STATS"] is defined %}
        _SD_PRINTER_STATS
    {% endif %}

    # --- 7. MOTOR SAFETY ---
    # Voron 2.4: Disable XY and Extruder, but KEEP Z ENABLED to prevent gantry drop.
    M84 X Y E

    # --- 8. FINISH ---
    STATUS_LEDS COLOR="done_printing"

    # Optional: If you use LED Effects
    SET_LED_EFFECT EFFECT=cl_done_printing REPLACE=1

    { action_respond_info("Print Complete. Inspect Surface Quality.") }
