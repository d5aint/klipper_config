[gcode_macro START_PRINT]
description: Machine heatup procedure with strict thermal ordering (Bed -> Chamber -> Nozzle)
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set verbose = vars.verbose %}
    {% set safe_temp = vars.safe_extruder_temp|float %}
    {% set travel_speed = vars.travel_speed * 60 %}
    {% set prime_line_x, prime_line_y = vars.prime_line_xy|map('float') %}

    {% set MATERIAL = params.MATERIAL|default('NONE')|string|upper %}
    {% if MATERIAL == 'NONE' %}
        { action_raise_error("CRITICAL ERROR: No MATERIAL argument provided! Check Slicer Start G-code.") }
    {% elif MATERIAL not in vars.material_parameters %}
        { action_raise_error("CRITICAL ERROR: Material '%s' is unknown!" % (MATERIAL)) }
    {% else %}
        {% set material = vars.material_parameters[MATERIAL] %}
        {% if verbose %} RESPOND MSG="Loaded configuration for: {MATERIAL}" {% endif %}
    {% endif %}

    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(material.extruder_temp)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(material.bed_temp)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER|default(material.chamber_temp)|int %}
    {% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
    {% set SOAK_TIME = params.SOAK|default(material.soak)|int %} # Minutes

    # --- 1. SYSTEM INITIALIZATION ---
    STATUS_LEDS COLOR="busy"
    CLEAR_PAUSE             ; Clear stale pause state from previous cancelled jobs
    BED_MESH_CLEAR          ; Clear old mesh data
    SET_GCODE_OFFSET Z=0    ; Reset Z-Offset
    
    G90                     ; Absolute Positioning
    M83                     ; Relative Extrusion
    M220 S100               ; Reset Speed Override
    M221 S100               ; Reset Flow Override

    # Reset Filters
    STOP_FILTER FILTER_NAME="{vars.filter_chamber_name}"
    STOP_FILTER FILTER_NAME="{vars.filter_exhaust_name}"
    UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED_CHAMBER DURATION=0
    UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED_EXHAUST DURATION=0

    # --- 2. HEATING & SOAKING ---
    STATUS_LEDS COLOR="heating"
    {% if verbose %} RESPOND MSG="Heating Bed to {BED_TEMP}C..." {% endif %}

    # Heat Bed
    M140 S{BED_TEMP}

    # Start Chamber Filter for Air Circulation (Nevermore)
    {% if material.chamber_filter_enable %}
        START_FILTER FILTER_NAME="{vars.filter_chamber_name}" SPEED=1
    {% endif %}

    # Conditional Homing (If not homed, home now)
    _CG28

    # Park Center to warm the probe/toolhead evenly
    PARK MODE=CENTER

    # Wait for Bed Target
    M190 S{BED_TEMP}

    # Heat Soak Logic
    {% if SOAK_TIME > 0 %}
        {% if verbose %} RESPOND MSG="Soaking bed for {SOAK_TIME} mins..." {% endif %}
        G4 P{SOAK_TIME * 60000}
    {% endif %}

    # Chamber Soak (Material Specific)
    {% if MATERIAL == "ABS" or MATERIAL == "ASA" %}
        {% if verbose %} RESPOND MSG="Waiting for Chamber: {CHAMBER_TEMP}C" {% endif %}
        # We wait for the sensor on Octo T0 (Rear Gantry)
        TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={CHAMBER_TEMP}
    {% endif %}

    # --- 3. PROBING PREP ---
    # Heat nozzle to 'Safe Probe Temp' (150C) for Tap
    {% if verbose %} RESPOND MSG="Warming nozzle to {safe_temp}C for probing..." {% endif %}
    M109 S{safe_temp}

    STATUS_LEDS COLOR="cleaning"
    CLEAN_NOZZLE MATERIAL={MATERIAL}     ; Scrub debris so Z-offset is accurate

    STATUS_LEDS COLOR="leveling"
    QUAD_GANTRY_LEVEL       ; Level the Gantry
    
    STATUS_LEDS COLOR="homing"
    G28 Z                   ; Re-home Z after QGL

    # --- 4. MESHING ---
    STATUS_LEDS COLOR="meshing"
    ADAPTIVE_BED_MESH SIZE={FL_SIZE}

    # --- 5. FINAL HEAT ---
    STATUS_LEDS COLOR="heating"
    # Move near prime line start to avoid oozing over the print area while heating
    {% if verbose %} RESPOND MSG="Moving to Prime Line start..." {% endif %}
    G0 X{prime_line_x - 5} Y{prime_line_y} Z10 F{travel_speed}

    {% if verbose %} RESPOND MSG="Final Heating to {EXTRUDER_TEMP}C" {% endif %}
    M109 S{EXTRUDER_TEMP}

    # --- 6. PRINT PREP ---
    # Apply Material Params
    SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
    SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}

    # Apply Z-Offsets
    {% if material.additional_z_offset != 0 %}
        SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
        {% if verbose %} RESPOND MSG="Applied Material Z-Offset: {material.additional_z_offset}mm" {% endif %}
    {% endif %}

    # User adjustment from Slicer
    {% if params.Z_ADJUST %}
        {% if verbose %} RESPOND MSG="Applied User Z-Adjust: {Z_ADJUST}mm" {% endif %}
        SET_GCODE_OFFSET Z_ADJUST={params.Z_ADJUST} MOVE=1
    {% endif %}

    # --- 7. EXECUTION ---
    STATUS_LEDS COLOR="printing"
    _PRIMELINE
    G92 E0.0
    {% if verbose %} RESPOND MSG="Start printing!" {% endif %}
