[gcode_macro ACTIVATE_PROBE]
description: Ensure nozzle is cool enough for Tap
variable_temperature: 0
gcode:
    {% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}

    {% if ACTUAL_TEMP > safe_extruder_temp %}
        {action_respond_info('Extruder %.1fC is too hot for TAP. Cooling to %.1fC...' % (ACTUAL_TEMP, safe_extruder_temp))}
        M106 S255
        M109 S{safe_extruder_temp}
        M106 S0
    {% endif %}

[gcode_macro DEACTIVATE_PROBE]
description: Restore temp after probing
variable_temperature: 0
gcode:
    {% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}

    {% if old_target_temperature > 0 %}
        M104 S{old_target_temperature}
    {% endif %}
