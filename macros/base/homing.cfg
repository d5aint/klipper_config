[gcode_macro _CG28]
description: Homing only if necessary
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        STATUS_LEDS COLOR="homing"
        G28
        STATUS_LEDS COLOR="ready"
    {% endif %}

[homing_override]
axes: xyz
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set sensorless_current_factor = vars.sensorless_current_factor / 100 %}
    {% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
    {% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
    {% set x_position_center  = printer.toolhead.axis_maximum.x|int / 2 - printer.toolhead.axis_minimum.x|int / 2 %}
    {% set y_position_center  = printer.toolhead.axis_maximum.y|int / 2 - printer.toolhead.axis_minimum.y|int / 2 %}
    {% set zhop = vars.zhop|float|abs %}
    {% set zhop_speed = vars.zhop_speed * 60 %}
    {% set homing_travel_speed = vars.homing_travel_speed * 60 %}
    {% set homing_travel_accel = vars.homing_travel_accel %}
    {% set x_homing_backoff, y_homing_backoff = vars.homing_backoff_distance_xy|map('float') %}

    {% set saved_accel = printer.toolhead.max_accel %}
    {% set saved_decel = printer.configfile.settings.printer.max_accel_to_decel|default(saved_accel * 0.5) %}

    # Initialize target axes
    {% set X, Y, Z = False, False, False %}
    {% if not 'X' in params and not 'Y' in params and not 'Z' in params %}
        {% set X, Y, Z = True, True, True %}
    {% else %}
        {% if 'X' in params %}{% set X = True %}{% endif %}
        {% if 'Y' in params %}{% set Y = True %}{% endif %}
        {% if 'Z' in params %}{% set Z = True %}{% endif %}
        # If all axes are requested, reset homing state variables
        {% if 'X' in params and 'Y' in params and 'Z' in params %}
            _HOMING_VARIABLES reset=1
        {% endif %}
    {% endif %}

    # Sensorless Homing Current Reduction
    {% set old_current_x = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set old_current_y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set new_current_x = sensorless_current_factor * old_current_x %}
    {% set new_current_y = sensorless_current_factor * old_current_y %}

    # Limits accel to homing_travel_accel set in the variables config to protect kinematic mounts and reduce noise during the procedure
    SET_VELOCITY_LIMIT ACCEL={homing_travel_accel} ACCEL_TO_DECEL={(homing_travel_accel * 0.5)}

    STATUS_LEDS COLOR="homing"

    G90
    BED_MESH_CLEAR

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}

    # Handle Z-Safe Homing / Forced full home if Z is requested but XY not homed
    {% if Z %}
        {% if "z" in printer.toolhead.homed_axes %}
            {% if (printer.toolhead.position.z < zhop) %}
                {% if vars.verbose %}{action_respond_info("Z too low, performing ZHOP to rehome Z")}{% endif %}
                G91
                G0 Z{zhop} F{zhop_speed}
                G90
            {% endif %}
        {% elif ('xy' not in printer.toolhead.homed_axes) %}
            {% if vars.verbose %}{action_respond_info("X and Y not homed, forcing full G28 to home Z properly")}{% endif %}
            SET_KINEMATIC_POSITION X=0 Y=0 Z=0
            G0 Z{zhop} F{zhop_speed}
            # Force X and Y to home since we don't know where we are
            {% set X, Y, Z = True, True, True %}
        {% endif %}
    {% endif %}

    # Home X
    {% if X %}
        {% if vars.verbose %}{action_respond_info("Homing X")}{% endif %}
        G28 X0
        # Backoff to release endstop/bumper
        G0 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
        M400
    {% endif %}

    # Home Y
    {% if Y %}
        # CHECK: If X is not already homed AND we didn't just home it in this macro
        {% if "x" not in printer.toolhead.homed_axes and not X %}
            {% if vars.verbose %}{action_respond_info("X not homed, forcing homing X first")}{% endif %}
            G28 X0
            G0 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
            M400
        {% else %}
            # If X was already homed OR we just homed it (X=True), move to safe Y start
            {% if vars.verbose %}{action_respond_info("Moving to safe location to home Y")}{% endif %}
            G0 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
            G4 S1
        {% endif %}

        {% if vars.verbose %}{action_respond_info("Homing Y")}{% endif %}
        G28 Y0
        G0 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
        M400
    {% endif %}

    # Home Z
    {% if Z %}
        # Move to center of bed (Kinematic mount safe zone)
        G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}

        # ACTIVATE_PROBE logic (Safety for TAP, ensure this macro exists or is empty)
        ACTIVATE_PROBE
        {% if vars.verbose %}{action_respond_info("Homing Z")}{% endif %}
        G28 Z0

        # Safe Z-Hop post-home
        G91
        G0 Z{zhop} F{homing_travel_speed}
        G90
        DEACTIVATE_PROBE
    {% endif %}

    # Restore Currents (Sensorless)
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}

    # Reset acceleration to system max for normal printing
    SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
    STATUS_LEDS COLOR="ready"
