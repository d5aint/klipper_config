[gcode_macro CHANGE_FILAMENT]
description: Pause, park, and unload. Usage: CHANGE_FILAMENT MATERIAL=PLA
gcode:
    # Pass the material param down to the unload macro
    {% set MATERIAL = params.MATERIAL|default('PLA')|string %}

    # 1. Pause the print (Saves current print position)
    PAUSE

    # 2. Unload the filament (Parks toolhead at front)
    UNLOAD_FILAMENT MATERIAL={MATERIAL}
    
    # 3. Message user
    M117 Filament Unloaded. Insert New.
    RESPOND MSG="Filament Unloaded. Please insert new filament, run LOAD_FILAMENT, then RESUME."

[gcode_macro LOAD_FILAMENT]
description: Load filament with Material Database. Usage: LOAD_FILAMENT MATERIAL=PLA
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set filament_type = params.MATERIAL|default('PLA')|string|upper %}
    {% set DISTANCE = params.DISTANCE|default(120)|float %}
    
    # 1. Lookup Material Data (Data-Driven)
    {% set material_db = vars.material_parameters %}
    {% set mat_settings = material_db[filament_type] if filament_type in material_db else material_db['PLA'] %}
    {% set temp_target = mat_settings.extruder_temp|int %}

    # 2. Homing & Parking
    # Ensure toolhead is in a known, accessible position for maintenance
    _CG28
    PARK MODE=FRONT

    # 3. Heating
    # We must wait (M109) to ensure we don't grind filament against a cold nozzle or cook it
    STATUS_LEDS COLOR="heating"
    {% if vars.verbose %}RESPOND MSG="Setting temprature on extruder to {temp_target}C for {filament_type} Load..."{% endif %}
    M109 S{temp_target}

    STATUS_LEDS COLOR="busy"
    SAVE_GCODE_STATE NAME=LOAD_FILAMENT

    # 4. Intelligent Load Logic
    # 50mm is approx distance from Galileo 2 gears to Revo heatbreak entrance
    {% set FAST_LOAD_LEN = 50 %}
    
    M83       ; Relative Extrusion
    G92 E0    ; Reset Extruder

    {% if DISTANCE > FAST_LOAD_LEN %}
        {% if vars.verbose %}RESPOND MSG="Fast loading {FAST_LOAD_LEN}..."{% endif %}
        # Phase A: Fast Approach (Get to the nozzle)
        G1 E{FAST_LOAD_LEN} F1800 
        
        # Phase B: Slow Purge (Flush old color / Fill Nozzle)
        # We slow down to 300mm/min (5mm/s) to ensure good melt and no skipping
        {% set load_dist = DISTANCE - FAST_LOAD_LEN %}
        {% if vars.verbose %}RESPOND MSG="Slow loading {load_dist}..."{% endif %}
        G1 E{DISTANCE - FAST_LOAD_LEN} F300
    {% else %}
        # Short distance requested? Just move slow.
        {% if vars.verbose %}RESPOND MSG="Slow loading {DISTANCE}..."{% endif %}
        G1 E{DISTANCE} F300
    {% endif %}

    # 5. Ooze Prevention
    # Tiny retraction to stop the nozzle from drooling while you clean it
    G1 E-2.0 F1800

    M400      ; Wait for moves to finish
    G92 E0
    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT

    # 6. Re-Enable Safety Systems
    # Now that filament is loaded and static, we turn the sensor back on.
    {% if vars.filament_sensor_enabled %}
        SET_FILAMENT_SENSOR SENSOR="filament_sensor" ENABLE=1
    {% endif %}

    STATUS_LEDS COLOR="ready"
    RESPOND MSG="Filament Loaded: {filament_type}"

[gcode_macro UNLOAD_FILAMENT]
description: Unload with Tip Shaping. Usage: UNLOAD_FILAMENT MATERIAL=PLA
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set filament_type = params.MATERIAL|default('PLA')|string|upper %}
    {% set DISTANCE = params.DISTANCE|default(80)|float %}

    # 1. Lookup Material Data
    {% set material_db = vars.material_parameters %}
    {% set mat_settings = material_db[filament_type] if filament_type in material_db else material_db['PLA'] %}
    {% set temp_target = mat_settings.extruder_temp|int %}

    # 2. Homing & Parking
    # Ensure toolhead is in a known, accessible position for maintenance
    _CG28
    PARK MODE=FRONT

    # 3. Temperature Safety Check
    # We use M109 because we need the melt zone fully saturated to form a clean tip.
    {% if vars.verbose %}RESPOND MSG="Setting temprature on extruder to {temp_target}C for {filament_type} Unload..."{% endif %}
    STATUS_LEDS COLOR="heating"
    M109 S{temp_target}

    STATUS_LEDS COLOR="busy"

    # 4. Disable Filament Sensor
    # Prevent false runout triggers as we pull filament past the switch
    {% if vars.filament_sensor_enabled %}
        SET_FILAMENT_SENSOR SENSOR="filament_sensor" ENABLE=0
    {% endif %}

    # 5. Tip Shaping Sequence
    G91

    # A. RAM: Push forward to melt the tip.
    # If you find you are still getting "hairs" or strings getting stuck in the Galileo 2 gears:
    # Increase the RAM amount (G1 E10 -> G1 E15)
    G1 E5 F300

    # B. JERK: Rapid retraction to break the melt strand.
    G1 E-10 F3000

    # C. COOL: Wait 2 seconds for the tip to skin over.
    # If you find you are still getting "hairs" or strings getting stuck in the Galileo 2 gears:
    # Increase the COOL wait (G4 P2000 -> G4 P3000).
    G4 P3000

    G1 E10 F1800
    G1 E-10 F2600

    # E. EXTRACT: Pull past the drive gears
    #    ~50mm clears the Galileo 2 and enters the reverse bowden
    #    Initial slow pull to clear the break zone
    G1 E-28 F1800

    # Determine the remaining distance to unload
    {% set unload_dist = DISTANCE - 20 %}

    # Fast pull for the rest (only if there is any left)
    {% if vars.verbose %}RESPOND MSG="Unloading {unload_dist}..."{% endif %}
    {% if unload_dist > 0 %}
        G1 E-{unload_dist} F3000
    {% endif %}

    M400      ; Wait for moves to finish
    G90

    STATUS_LEDS COLOR="ready"
    RESPOND MSG="Filament Unloaded: {filament_type}"

[gcode_macro PURGE_FILAMENT]
description: Purge filament with data-driven temp and optional move. Usage: PURGE_FILAMENT MATERIAL=PLA MOVE=True
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set filament_type = params.MATERIAL|default('PLA')|string|upper %}
    {% set DISTANCE = params.DISTANCE|default(40)|float %}
    {% set MOVE_TO_BUCKET = params.MOVE|default('false')|string|lower == 'true' %}

    # 1. Lookup Material Data
    {% set material_db = vars.material_parameters %}
    {% set mat_settings = material_db[filament_type] if filament_type in material_db else material_db['PLA'] %}
    {% set temp_target = mat_settings.extruder_temp|int %}

    SAVE_GCODE_STATE NAME=PURGE_FILAMENT

    # 2. Movement Logic (Conditional)
    {% if MOVE_TO_BUCKET %}
        STATUS_LEDS COLOR="busy"
        {% if vars.verbose %}RESPOND MSG="Moving to Purge Bucket..."{% endif %}
        _CG28
        G90

        # Retrieve Bucket Coords from variables.cfg
        {% set bucket_x = vars.purge_bucket_xyz[0] | float %}
        {% set bucket_y = vars.purge_bucket_xyz[1] | float %}
        {% set bucket_z = vars.purge_bucket_xyz[2] | float %}

        # Safe Z-Lift before travel
        {% if printer.toolhead.position.z < bucket_z %}
            G1 Z{bucket_z + 10} F{vars.zhop_speed * 60}
        {% endif %}
        
        # Move to the bucket location
        G1 X{bucket_x} Y{bucket_y} Z{bucket_z} F{vars.travel_speed * 60}
        G4 P2000 # Wait 2s for bucket to settle/vibrations to dampen
    {% endif %}

    # 3. Heating
    {% if vars.verbose %}RESPOND MSG="Setting temprature on extruder to {temp_target}C for {filament_type} Unload..."{% endif %}
    STATUS_LEDS COLOR="heating"
    M109 S{temp_target}

    # 4. Purge Sequence
    STATUS_LEDS COLOR="cleaning"
    {% if vars.verbose %}RESPOND MSG="Purging {DISTANCE}mm of {filament_type}..."{% endif %}

    M83      ; Relative Extrusion
    G92 E0   ; Reset Extruder

    # Slow, consistent flow (5mm/s) to ensure smooth melt
    G1 E{DISTANCE} F300 

    # Retract to cut pressure/ooze
    G1 E-2.0 F1800
    
    # Wait for pressure to settle
    M400
    G92 E0

    RESTORE_GCODE_STATE NAME=PURGE_FILAMENT
    STATUS_LEDS COLOR="ready"
