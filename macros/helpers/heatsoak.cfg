[gcode_macro HEATSOAK_BED]
description: Heatsoak bed at specified temperature with optimal parking
gcode:
    {% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
    {% set TIME = params.SOAKTIME|default(8)|int %}
    {% set MOVE = params.MOVE|default(1)|int %}

    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set St = vars.travel_speed * 60 %}
    {% set Sz = vars.zhop_speed * 60 %}
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}

    {% set safe_temp = vars.safe_extruder_temp|float %}

    SAVE_GCODE_STATE NAME=HEATSOAK_BED

    {% if MOVE == 1 %}
        _CG28
        G90
        G0 Z30 F{Sz}
        G0 X{max_x / 2} Y{max_y / 2} F{St}
    {% endif %}

    STATUS_LEDS COLOR="heating"
    {% if vars.verbose %}{ action_respond_info("Heating Bed to %sC..." % SETPOINT_TEMP) }{% endif %}

    M190 S{SETPOINT_TEMP}

    {% if TIME > 0 %}
        {% for i in range(0, TIME) %}
            M117 Heatsoak: {TIME-i}m remaining...
            {action_respond_info("Heatsoak bed, %dmn left..." % (TIME-i))}
            G4 P{60000 * 1}
        {% endfor %}
    {% else %}
        {action_respond_info("No heatsoak needed, continuing...")}
    {% endif %}

    STATUS_LEDS COLOR="ready"
    {action_respond_info("Bed Temperature Equilibrated.")}
    RESTORE_GCODE_STATE NAME=HEATSOAK_BED
