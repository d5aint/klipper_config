[gcode_macro SET_NOZZLE]
description: Tell the printer what nozzle is installed. Usage: SET_NOZZLE SIZE=0.4
gcode:
    {% set SIZE = params.SIZE|default(0.4)|float %}

    SAVE_VARIABLE VARIABLE=current_nozzle_size VALUE={SIZE}
    M118 Nozzle size set to {SIZE}mm.

[gcode_macro CHECK_NOZZLE]
description: Safety check called by Slicer Start G-code
gcode:
    {% set SLICER_NOZZLE = params.SIZE|default(0.4)|float %}
    {% set INSTALLED_NOZZLE = printer.save_variables.variables.current_nozzle_size|default(0.4)|float %}

    {% if SLICER_NOZZLE != INSTALLED_NOZZLE %}
        {action_respond_info("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")}
        {action_respond_info(" SAFETY ABORT: NOZZLE MISMATCH")}
        {action_respond_info(" Slicer wants: " ~ SLICER_NOZZLE ~ "mm")}
        {action_respond_info(" Printer has:  " ~ INSTALLED_NOZZLE ~ "mm")}
        {action_respond_info(" Run SET_NOZZLE SIZE=" ~ SLICER_NOZZLE ~ " to confirm change.")}
        {action_respond_info("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")}
        CANCEL_PRINT
    {% else %}
        M118 Nozzle check passed: {SLICER_NOZZLE}mm verified.
    {% endif %}
