[gcode_macro CLEAN_NOZZLE]
description: Wipe the nozzle with material-specific heat logic and State Restoration
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set St = vars.travel_speed * 60 %}
    {% set Sc = vars.brush_clean_speed * 60 %}
    {% set Bx, By, Bz = vars.brush_xyz|map('float') %}
    {% set do_y_wipe = vars.brush_over_y_axis %}

    # --- 1. PARAMETER & VARIABLE SETUP ---
    {% set MATERIAL = params.MATERIAL|default('PLA')|string|upper %}
    {% set mat_db = vars.material_parameters %}
    # Fallback to PLA if material not found
    {% set mat = mat_db[MATERIAL] if MATERIAL in mat_db else mat_db['PLA'] %}

    # Use the defined cleaning_temp, or default to 150 if undefined
    {% set target_clean_temp = mat.cleaning_temp|default(150)|int %}

    # SNAPSHOT: Capture the current target temp (0 if off, 150 if in start_print)
    {% set initial_target = printer.extruder.target|int %}

    {% set WIPE_DIST_X = 46 %}
    {% set WIPE_DIST_Y = 6 %}

    _CG28
    SAVE_GCODE_STATE NAME=CLEAN_NOZZLE

    # --- 2. HEATING LOGIC ---
    STATUS_LEDS COLOR="cleaning"

    # Only heat up if we are currently colder than the cleaning temp
    {% if printer.extruder.temperature < target_clean_temp %}
        {% if vars.verbose %}RESPOND MSG="Heating to {target_clean_temp}C for {MATERIAL} (Moving to brush)..."{% endif %}
        M104 S{target_clean_temp}
    {% endif %}

    # --- 3. MOVEMENT & SCRUB ---
    G90
    G1 X{Bx} Y{By} F{St}
    G1 Z{Bz} F{St}

    # --- 4. OPTIMIZED HEATING (Finish) ---
    # Now that we are at the brush, ensure we hit target temp before touching bristles
    {% if printer.extruder.temperature < target_clean_temp %}
        M109 S{target_clean_temp}
    {% endif %}
    
    # --- 5. SCRUB PATTERN ---
    M204 S{vars.brush_clean_accel}
    G91

    # Scrub X
    {% for wipe in range(6) %}
        G1 X{WIPE_DIST_X/2} F{Sc}
        G1 X-{WIPE_DIST_X} F{Sc}
        G1 X{WIPE_DIST_X/2} F{Sc}
    {% endfor %}

    G1 Z+0.5 F{Sc}

    # Scrub X again (Raised)
    {% for wipe in range(6) %}
        G1 X{WIPE_DIST_X/2} F{Sc}
        G1 X-{WIPE_DIST_X} F{Sc}
        G1 X{WIPE_DIST_X/2} F{Sc}
    {% endfor %}

    # Scrub Y (Optional)
    {% if do_y_wipe %}
        {% for wipe in range(6) %}
        G1 Y-{WIPE_DIST_Y} F{Sc}
        G1 Y+{WIPE_DIST_Y} F{Sc}
        {% endfor %}
    {% endif %}
    
    M204 S{printer.toolhead.max_accel}
    G90
    G1 Z10 F{St}

    # --- 6. STATE RESTORATION ---
    {% if initial_target == 0 %}
        # Case A: Printer was idle. Turn everything off.
        {% if vars.verbose %}RESPOND MSG="Cleaning complete. Turning Heater OFF."{% endif %}
        M104 S0
    {% elif initial_target < target_clean_temp %}
        # Case B: We are in START_PRINT (target was 150). We MUST cool down and WAIT (M109).
        # If we don't wait, the nozzle will still be 200C when it tries to Tap -> Ooze city.
        {% if vars.verbose %}RESPOND MSG="Cooling back to {initial_target}C for Tap Safety..."{% endif %}
        M109 S{initial_target}
    {% else %}
        # Case C: We were printing or hot. Just return to target (M104 is fine).
        M104 S{initial_target}
    {% endif %}

    RESTORE_GCODE_STATE NAME=CLEAN_NOZZLE
    STATUS_LEDS COLOR="ready"
